const express = require('express');
const app = express();
const port = 3000;

// Middleware global: se aplica a todas las rutas
app.use((req, res, next) => {
    console.log(`Request method: ${req.method} | Request URL: ${req.url}`);
    next(); // Pasa al siguiente middleware o ruta
});

// Middleware para analizar el cuerpo de las solicitudes en formato JSON
app.use(express.json());

// Middleware específico para una ruta
const checkAuth = (req, res, next) => {
    const token = req.headers['authorization'];

    if (!token) {
        return res.status(401).json({ error: 'Acceso no autorizado, falta el token.' });
    }

    if (token === 'valid-token') {
        console.log('Token validado con éxito');
        next(); // Pasa a la siguiente capa
    } else {
        return res.status(403).json({ error: 'Token inválido.' });
    }
};

// Ruta sin middleware
app.get('/', (req, res) => {
    res.send('¡Bienvenido a la aplicación!');
});

// Ruta con middleware específico
app.get('/protected', checkAuth, (req, res) => {
    res.send('¡Has accedido a una ruta protegida!');
});

// Middleware específico para un grupo de rutas (Router)
const userRouter = express.Router();

// Middleware aplicado a todas las rutas del router
userRouter.use((req, res, next) => {
    console.log('Middleware de usuario aplicado');
    next();
});

// Ruta dentro del router
userRouter.get('/profile', (req, res) => {
    res.json({ user: 'John Doe', email: 'john.doe@example.com' });
});

// Otra ruta dentro del router
userRouter.get('/settings', (req, res) => {
    res.json({ theme: 'dark', notifications: true });
});

// Asignar el router al camino `/users`
app.use('/users', userRouter);

// Middleware de manejo de errores (debe ir al final)
app.use((err, req, res, next) => {
    console.error(err.stack);
    res.status(500).json({ error: 'Algo salió mal. Por favor intenta más tarde.' });
});

// Iniciar el servidor
app.listen(port, () => {
    console.log(`Servidor corriendo en http://localhost:${port}`);
});
